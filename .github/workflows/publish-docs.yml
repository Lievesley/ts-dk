name: Publish docs

on:
    push:
        branches: [main]
        tags: ["*"]
    workflow_dispatch: {}

permissions:
    contents: write

env:
    NODE_VERSION: lts/*
    SITE_DIST: packages/docs-site/build
    STAGE: ./gh-pages

jobs:
    build-and-publish:
        runs-on: ubuntu-latest
        env:
            REPO_NAME: ${{ github.event.repository.name }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Set up pnpm
              uses: pnpm/action-setup@v4
            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm
            - name: Install dependencies
              run: pnpm install --frozen-lockfile
            - name: Build Docusaurus site (root)
              env:
                  BASE_URL: "/${{ env.REPO_NAME }}/"
                  ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
                  ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_API_KEY }}
                  ALGOLIA_INDEX_NAME: ${{ secrets.ALGOLIA_INDEX_NAME }}
              run: pnpm run docs:build

            - name: Stage site
              run: |
                  rm -rf "${{ env.STAGE }}"
                  mkdir -p "${{ env.STAGE }}"
                  rsync -a --delete "${{ env.SITE_DIST }}/" "${{ env.STAGE }}/"

            - name: Build and stage versioned snapshot (tag only)
              if: ${{ github.ref_type == 'tag' }}
              env:
                  VERSION_DIR: ${{ startsWith(github.ref_name, 'v') && github.ref_name || format('v{0}', github.ref_name) }}
                  BASE_URL: "/${{ env.REPO_NAME }}/${{ startsWith(github.ref_name, 'v') && github.ref_name || format('v{0}', github.ref_name) }}/"
                  ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
                  ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_API_KEY }}
                  ALGOLIA_INDEX_NAME: ${{ secrets.ALGOLIA_INDEX_NAME }}
              run: |
                  pnpm run docs:build

                  mkdir -p "${{ env.STAGE }}/${{ env.VERSION_DIR }}"
                  rsync -a --delete "${{ env.SITE_DIST }}/" "${{ env.STAGE }}/${{ env.VERSION_DIR }}/"

            - name: Deploy to GitHub Pages
              uses: peaceiris/actions-gh-pages@v3
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  publish_branch: gh-pages
                  publish_dir: ${{ env.STAGE }}
                  keep_files: true
